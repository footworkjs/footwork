/**, * footwork.js - A solid footing for web applications., * Author: Jonathan Newman (http://staticty.pe), * Version: v0.8.0pre, * Url: http://footworkjs.com, * License(s): MIT, */,,function isPath(e){return hasTrailingSlash.test(e)}function hasPathStart(e){return hasStartingSlash.test(e)}function hasHashStart(e){return hasStartingHash.test(e)}function hasClass(e,t){return e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))}function addClass(e,t){hasClass(e,t)||(e.className+=(e.className.length?" ":"")+t)}function removeClass(e,t){if(hasClass(e,t)){var n=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(n," ")}}function parseUri(e){for(var t=parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),i={},s=14;s--;)i[t.key[s]]=n[s]||"";return i[t.q.name]={},i[t.key[12]].replace(t.q.parser,function(e,n,s){n&&(i[t.q.name][n]=s)}),i}function indexedNamespaceName(e,t){return isUndefined(namespaceNameCounter[e])?namespaceNameCounter[e]=0:namespaceNameCounter[e]++,e+(t===!0?namespaceNameCounter[e]:"")}function createEnvelope(e,t,n){var i={topic:e,data:t};return isUndefined(n)||(i.headers={preserve:!0},n instanceof Date&&(i.expires=n)),i}function triggerEventOnNamespace(e,t,n){return this.publish(createEnvelope("event."+e,t,n)),this}function registerNamespaceEventHandler(e,t,n){isUndefined(n)||(t=t.bind(n));var i=this.subscribeToTopic("event."+e,t).enlistPreserved();return this.eventHandlers.push(i),i}function unregisterNamespaceHandler(e){return e.unsubscribe(),this}function sendCommandToNamespace(e,t,n){return this.publish(createEnvelope("command."+e,t,n)),this}function registerNamespaceCommandHandler(e,t,n){isUndefined(n)||(t=t.bind(n));var i=this.subscribeToTopic("command."+e,t).enlistPreserved();return this.commandHandlers.push(i),i}function requestResponseFromNamespace(e,t,n){var i,s=void 0;return i=this.subscribeToTopic("request."+e+".response",function(e){isUndefined(s)?s=n?[e]:e:n&&s.push(e)}),this.publish(createEnvelope("request."+e,t)),i.unsubscribe(),s}function registerNamespaceRequestHandler(e,t,n){isUndefined(n)||(t=t.bind(n));var i=function(n){var i=t(n);this.publish(createEnvelope("request."+e+".response",i))}.bind(this),s=this.subscribeToTopic("request."+e,i);return this.requestHandlers.push(s),s}function disconnectNamespaceHandlers(){var e=this;return each(["requestHandlers","commandHandlers","eventHandlers","subscriptions"],function(t){invoke(e[t],"unsubscribe")}),this}function getNamespaceName(){return this.channel}function propertyDisposal(e){(isNamespace(e)||isRouter(e)||isBroadcastable(e)||isReceivable(e)||isObservable(e))&&isFunction(e.dispose)&&e.dispose()}function isReceivable(e){return isObject(e)&&!!e.__isReceivable}function isBroadcastable(e){return isObject(e)&&!!e.__isBroadcastable}function transformRouteConfigToDesc(e){return extend({id:uniqueId("route")},baseRouteDescription,e)}function routeStringToRegExp(e){return e=e.replace(escapeRegex,"\\$&").replace(optionalParamRegex,"(?:$1)?").replace(namedParamRegex,function(e,t){return t?e:"([^/]+)"}).replace(splatParamRegex,"(.*?)"),new RegExp("^"+e+("/"!==e?"(\\/.*)*$":"$"),routesAreCaseSensitive?void 0:"i")}function historyIsReady(){var e=has(History,"Adapter");return e&&!History.Adapter.isSetup&&(History.Adapter.isSetup=!0,History.options.html4Mode=fwRouters.html5History()?!1:!0,History.init(),History.Adapter.unbind=function(e){each(History.Adapter.handlers,function(t){t.statechange=filter(t.statechange,function(t){return t!==e})})}),e}function isNullRouter(e){return isObject(e)&&!!e.__isNullRouter}function isRouter(e){return isObject(e)&&!!e.__isRouter}function isRoute(e){return isObject(e)&&!!e.__isRoute}function nearestParentRouter(e){var t=$nullRouter;return isObject(e)&&(isObject(e.$data)&&isRouter(e.$data.$router)?t=e.$data.$router:(isObject(e.$parentContext)||isObject(e.$data)&&isObject(e.$data.$parentContext))&&(t=nearestParentRouter(e.$parentContext||e.$data.$parentContext))),t}function isViewModelCtor(e){return isFunction(e)&&!!e.__isViewModelCtor}function isViewModel(e){return isObject(e)&&!!e.__isViewModel}function beforeInitMixins(e){return!!e.runBeforeInit}function applyContextAndLifeCycle(e,t){if(isViewModel(e)){var n=e.__getConfigParams();t=t||document.body,e.$element=t,e.$context=elementContext=fw.contextFor(t),isFunction(n.afterBinding)&&n.afterBinding.call(e,t),isRouter(e.$router)&&e.$router.context(elementContext),isUndefined(t)||fw.utils.domNodeDisposal.addDisposeCallback(t,function(){e.dispose()})}}function bindComponentViewModel(e,t,n){var i;i=isFunction(n)?new n(values.params):n,i.$parentContext=fw.contextFor(e.parentElement||e.parentNode),each(e.children,function(e){originalApplyBindings(i,e)}),applyContextAndLifeCycle(i,e),isRouter(i.$router)&&i.$router.context(fw.contextFor(e))}function isNativeComponent(e){return-1!==indexOf(nativeComponents,e)}function componentTriggerAfterBinding(e,t){if(isViewModel(t)){var n=t.__getConfigParams();isFunction(n.afterBinding)&&n.afterBinding.call(t,e)}}var fw=ko;fw.footworkVersion="0.8.0pre",fw.embed=embedded;var hasTrailingSlash=/\/$/i,hasStartingSlash=/^\//i,hasStartingHash=/^#/i,noop=function(){},isObservable=fw.isObservable,isFunction=_.isFunction,isObject=_.isObject,isString=_.isString,isBoolean=_.isBoolean,isNumber=_.isNumber,isUndefined=_.isUndefined,isArray=_.isArray,isNull=_.isNull,contains=_.contains,extend=_.extend,pick=_.pick,each=_.each,filter=_.filter,bind=_.bind,invoke=_.invoke,clone=_.clone,reduce=_.reduce,has=_.has,where=_.where,result=_.result,uniqueId=_.uniqueId,map=_.map,find=_.find,omit=_.omit,indexOf=_.indexOf,values=_.values,reject=_.reject,findWhere=_.findWhere,once=_.once,last=_.last,viewModelMixins=[];parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var namespaceNameCounter={},namespaceStack=[],makeNamespace=fw.namespace=function(e,t){isUndefined(t)||(isString(t)?e=t+"."+e:isUndefined(t.channel)||(e=t.channel+"."+e));var n=postal.channel(e),i=n.subscriptions=[],s=n.subscribeToTopic=n.subscribe;return n.subscribe=function(e,t){var o=s.call(n,e,t);return i.push(o),o},n.unsubscribe=unregisterNamespaceHandler,n.__isNamespace=!0,n.dispose=disconnectNamespaceHandlers.bind(n),n.commandHandlers=[],n.command=sendCommandToNamespace.bind(n),n.command.handler=registerNamespaceCommandHandler.bind(n),n.command.unregister=unregisterNamespaceHandler,n.requestHandlers=[],n.request=requestResponseFromNamespace.bind(n),n.request.handler=registerNamespaceRequestHandler.bind(n),n.request.unregister=unregisterNamespaceHandler,n.eventHandlers=[],n.event=n.trigger=triggerEventOnNamespace.bind(n),n.event.handler=registerNamespaceEventHandler.bind(n),n.event.unregister=unregisterNamespaceHandler,n.getName=getNamespaceName.bind(n),n.enter=function(){return enterNamespace(this)},n.exit=function(){return currentNamespaceName()===this.getName()?exitNamespace():void 0},n},isNamespace=fw.isNamespace=function(e){return!isUndefined(e)&&!!e.__isNamespace},currentNamespaceName=fw.currentNamespaceName=function(){return namespaceStack[0]},currentNamespace=fw.currentNamespace=function(){return makeNamespace(currentNamespaceName())},enterNamespaceName=fw.enterNamespaceName=function(e){currentNamespace();return namespaceStack.unshift(e),makeNamespace(currentNamespaceName())},enterNamespace=fw.enterNamespace=function(e){return namespaceStack.unshift(e.getName()),e},exitNamespace=fw.exitNamespace=function(){return namespaceStack.shift(),currentNamespace()};viewModelMixins.push({runBeforeInit:!0,_preInit:function(){var e=this.__getConfigParams();this.$namespace=enterNamespaceName(indexedNamespaceName(e.namespace||e.name||_.uniqueId("namespace"),e.autoIncrement)),this.$globalNamespace=makeNamespace()},mixin:{getNamespaceName:function(){return this.$namespace.getName()}},_postInit:function(){exitNamespace()}});var $globalNamespace=makeNamespace();fw.start=function(e){e=e||windowObject.document.body,originalApplyBindings({},e)},fw.subscribable.fn.receiveFrom=function(e,t){var n=this,i=this,s=[],o=!1;if(isString(e)&&(e=makeNamespace(e),o=!0),!isNamespace(e))throw"Invalid namespace provided for receiveFrom() observable.";i=fw.computed({read:n,write:function(n){e.publish("__change."+t,n)}}),i.refresh=function(){return e.publish("__refresh."+t),this},s.push(e.subscribe(t,function(e){n(e)}));var r=i.dispose;return i.dispose=i.dispose=function(){invoke(s,"unsubscribe"),o&&e.dispose(),r.call(i)},i.__isReceivable=!0,i.refresh()},fw.subscribable.fn.broadcastAs=function(e,t){var n,i=this,s=[],o=[],r=!1;if(t=isObject(e)?e:isBoolean(t)?{name:e,writable:t}:isObject(t)?extend({name:e},t):{name:e},n=t.namespace||currentNamespace(),isString(n)&&(n=makeNamespace(n),r=!0),!isNamespace(n))throw"Invalid namespace provided for broadcastAs() observable.";return t.writable&&o.push(n.subscribe("__change."+t.name,function(e){i(e)})),i.broadcast=function(){return n.publish(t.name,i()),this},o.push(n.subscribe("__refresh."+t.name,function(){n.publish(t.name,i())})),s.push(i.subscribe(function(e){n.publish(t.name,e)})),i.dispose=i.dispose=function(){invoke(o,"unsubscribe"),invoke(s,"dispose"),r&&n.dispose()},i.__isBroadcastable=!0,i.broadcast()};var alwaysPassPredicate=function(){return!0},emptyStringResult=function(){return""},routerDefaultConfig={namespace:"$router",baseRoute:null,isRelative:!0,activate:!0,routes:[]},optionalParamRegex=/\((.*?)\)/g,namedParamRegex=/(\(\?)?:\w+/g,splatParamRegex=/\*\w*/g,escapeRegex=/[\-{}\[\]+?.,\\\^$|#\s]/g,hashMatchRegex=/(^\/#)/,isFullURLRegex=/(^[a-z]+:\/\/|^\/\/)/i,routesAreCaseSensitive=!0,invalidRoutePathIdentifier="___invalid-route",$nullRouter=extend({},$baseRouter,{childRouters:extend(noop.bind(),{push:noop}),path:function(){return""},isRelative:function(){return!1},__isNullRouter:!0}),$baseRouter={path:emptyStringResult,segment:emptyStringResult,childRouters:fw.observableArray(),context:noop,__isRouter:!0},baseRoute={controller:noop,indexedParams:[],namedParams:{},__isRoute:!0},baseRouteDescription={filter:alwaysPassPredicate,__isRouteDesc:!0},noComponentSelected="_noComponentSelected",$routerOutlet=function(e,t,n){n=n||{},isFunction(n)&&(n={onComplete:n});var i=n.params,s=n.onComplete,o=this.outlets;e=fw.unwrap(e),isObservable(o[e])||(o[e]=fw.observable({name:noComponentSelected,params:{},__getOnCompleteCallback:function(){return noop}}));var r=o[e],a=r(),u=!1,c=r().name===noComponentSelected;if(isUndefined(t)||(a.name=t,u=!0),isUndefined(i)||(a.params=i,u=!0),u){if(isFunction(s)){var l=c?0:1;a.__getOnCompleteCallback=function(){var e=0===l;return l--,e?s:noop}}else a.__getOnCompleteCallback=function(){return noop};r.valueHasMutated()}return r};fw.outlets={registerView:function(e,t){registerComponent(e,{template:t})},registerViewLocation:function(e,t){registerLocationOfComponent(e,{template:t}),registerComponentAsTemplateOnly(e)}};var isFullURL=fw.isFullURL=function(e){return isString(e)&&isFullURLRegex.test(e)},fwRouters=fw.routers={baseRoute:fw.observable(""),activeRouteClassName:fw.observable("active"),disableHistory:fw.observable(!1).broadcastAs({name:"disableHistory",namespace:$globalNamespace}),html5History:fw.observable(!1),getNearestParent:function(e){var t=nearestParentRouter(e);return isNullRouter(t)?null:t},getAll:function(e){return isUndefined(e)||isArray(e)||(e=[e]),reduce($globalNamespace.request("__router_reference",void 0,!0),function(t,n){var i=isNamespace(n.$namespace)?n.$namespace.getName():null;return isUndefined(n.$viewModel)||(i=n.$viewModel.$namespace.getName()),isNull(i)||(isUndefined(e)||contains(e,i))&&(isUndefined(t[i])?t[i]=n:(isArray(t[i])||(t[i]=[t[i]]),t[i].push(n))),t},{})}};fw.router=function(e,t,n){return new Router(e,t,n)},fw.bindingHandlers.$route={init:function(e,t,n,i,s){function o(t){var n=m.url(),i=n||e.getAttribute("href")||"";if(!isNull(n)){if(isUndefined(n)&&(n=i),!isFullURL(i)){if(!hasPathStart(i))if(hasHashStart(i)){var s=u.currentRoute();isNull(s)||(i=u.currentRoute().segment+i),p=!0}else i="/"+i;t&&!isNullRouter(u)&&(i=u.parentRouter().path()+i,fwRouters.html5History()===!1&&(i="#"+(0===i.indexOf("/")?i.substring(1):i)))}return i}return null}function r(t,n){if(m.addActiveClass){var i=m.activeClass||fwRouters.activeRouteClassName();"/"===t&&(t=""),!isNull(n)&&n.segment===t&&isString(i)&&i.length?addClass(e,i):hasClass(e,i)&&removeClass(e,i)}}function a(){var t=g();"a"===e.tagName.toLowerCase()&&(e.href=(fwRouters.html5History()?"":"/")+h()),isObject(d)&&d.dispose(),d=u.currentRoute.subscribe(r.bind(null,t)),l===!1&&(l=!0,r(t,u.currentRoute()),fw.utils.registerEventHandler(e,m.on,function(e){var t=g(),n=m.handler.call(i,e,t);n&&(isString(n)&&(t=n),isString(t)&&!isFullURL(t)&&u.setState(t))}))}var u=nearestParentRouter(s),c=t(),l=!1,d=null,p=null,m={on:"click",url:function(){return null},addActiveClass:!0,activeClass:null,handler:function(e,t){return p?(windowObject.location.hash=m.url,!1):isFullURL(t)||2===e.which?!1:(e.preventDefault(),!0)}};if(isObservable(c)||isFunction(c)||isString(c))m.url=c;else if(isObject(c))extend(m,c);else{if(c)throw"Unknown type of url value provided to $route ["+typeof c+"]";m.url=e.getAttribute("href")}var f=m.url;isFunction(f)||(m.url=function(){return f});var h=o.bind(null,!0),g=o.bind(null,!1);isObservable(m.url)&&u.subscriptions.push(m.url.subscribe(a)),a(),ko.utils.domNodeDisposal.addDisposeCallback(e,function(){isObject(d)&&d.dispose()})}};var Router=function(e,t,n){extend(this,$baseRouter);var i,s=this.subscriptions=[];isViewModel(t)&&(i=t.getNamespaceName());var o=this.$globalNamespace=makeNamespace();this.id=uniqueId("router"),this.$namespace=makeNamespace(e.namespace||i+"Router"),this.$namespace.enter(),this.$namespace.command.handler("setState",this.setState,this),this.$namespace.request.handler("currentRoute",function(){return this.currentRoute()},this),this.$namespace.request.handler("urlParts",function(){return this.urlParts()},this),this.$viewModel=t,this.urlParts=fw.observable(),this.childRouters=fw.observableArray(),this.parentRouter=fw.observable($nullRouter),this.context=fw.observable(),this.historyIsEnabled=fw.observable(!1),this.disableHistory=fw.observable().receiveFrom(o,"disableHistory"),this.currentState=fw.observable("").broadcastAs("currentState"),this.config=e=extend({},routerDefaultConfig,e),this.config.baseRoute=fw.routers.baseRoute()+(result(e,"baseRoute")||""),this.isRelative=fw.computed(function(){return e.isRelative&&!isNullRouter(this.parentRouter())},this),this.currentRoute=fw.computed(function(){return this.getRouteForURL(this.normalizeURL(this.currentState()))},this),this.path=fw.computed(function(){var e=this.currentRoute(),t=(this.parentRouter(),this.parentRouter().path());return isRoute(e)&&(t+=e.segment),t},this);var r=$nullRouter;s.push(this.parentRouter.subscribe(function(e){isNullRouter(r)||r===e||r.childRouters.remove(this),e.childRouters.push(this),r=e},this)),s.push(this.currentRoute.subscribe(function(e){this.getActionForRoute(e)()},this));var a=this;this.$globalNamespace.request.handler("__router_reference",function(){return a}),this.outlets={},this.$outlet=$routerOutlet.bind(this),this.$outlet.reset=function(){each(this.outlets,function(e){e({name:noComponentSelected,params:{}})})}.bind(this),isUndefined(e.unknownRoute)||(isFunction(e.unknownRoute)&&(e.unknownRoute={controller:e.unknownRoute}),e.routes.push(extend(e.unknownRoute,{unknown:!0}))),this.setRoutes(e.routes),e.activate===!0&&s.push(this.context.subscribe(function(e){isObject(e)&&this.activate(e)},this)),this.context(t.$context||n),this.$namespace.exit()};Router.prototype.setRoutes=function(e){return this.routeDescriptions=[],this.addRoutes(e),this},Router.prototype.addRoutes=function(e){return this.routeDescriptions=this.routeDescriptions.concat(map(isArray(e)?e:[e],transformRouteConfigToDesc)),this},Router.prototype.activate=function(e,t){return this.startup(e,t),""===this.currentState()&&this.setState(),this};var doNotPushOntoHistory=!0,pushOntoHistory=!1;Router.prototype.setState=function(e){if(this.historyIsEnabled()&&!this.disableHistory())if(isString(e)){var t=!0;try{t=History.pushState(null,"",this.parentRouter().path()+e)}catch(n){t=!1}finally{if(t)return}}else isFunction(History.getState)&&this.currentState(this.normalizeURL(History.getState().url));else isString(e)&&this.currentState(this.normalizeURL(e))},Router.prototype.startup=function(e,t){return t=t||$nullRouter,isNullRouter(t)?isObject(e)&&(t=nearestParentRouter(e),t.id!==this.id&&this.parentRouter(t)):this.parentRouter(t),this.historyIsEnabled()||(historyIsReady()&&!this.disableHistory()?(History.Adapter.bind(windowObject,"popstate",this.stateChangeHandler=function(){!fwRouters.html5History()&&"/"===windowObject.location.pathname&&windowObject.location.hash.length>1?this.currentState(this.normalizeURL("/"+windowObject.location.hash.substring(1))):this.currentState(this.normalizeURL(windowObject.location.pathname+windowObject.location.hash))}.bind(this)),this.historyIsEnabled(!0)):this.historyIsEnabled(!1)),this},Router.prototype.dispose=function(){var e=this.parentRouter();isNullRouter(e)||e.childRouters.remove(this),this.historyIsEnabled()&&historyIsReady()&&History.Adapter.unbind(this.stateChangeHandler),this.$namespace.dispose(),this.$globalNamespace.dispose(),invoke(this.subscriptions,"dispose"),each(omit(this,function(e){return isViewModel(e)}),propertyDisposal)},Router.prototype.normalizeURL=function(e){var t=parseUri(e);return this.urlParts(t),e=fwRouters.html5History()||"/"!==t.path?t.path:"/"+t.anchor,isNull(this.config.baseRoute)||0!==e.indexOf(this.config.baseRoute)||(e=e.substr(this.config.baseRoute.length),e.length>1&&(e=e.replace(hashMatchRegex,"/"))),e},Router.prototype.getUnknownRoute=function(){var e=findWhere((this.getRouteDescriptions()||[]).reverse(),{unknown:!0})||null;return isNull(e)||(e=extend({},baseRoute,{id:e.id,controller:e.controller,title:e.title,segment:""})),e},Router.prototype.getRouteForURL=function(e){var t=null,n=this.parentRouter().path()||"",i=this.getUnknownRoute(),s=this;this.isRelative()&&n.length>0&&0===(routeIndex=e.indexOf(n+"/"))&&(e=e.substr(n.length));var o=[];if(find(this.getRouteDescriptions(),function(n){var i=n.route,r=[];return isString(i)&&(r=e.match(routeStringToRegExp(i)),!isNull(r)&&n.filter.call(s,r,s.urlParts())&&o.push({routeString:i,specificity:i.replace(namedParamRegex,"*").length,routeDescription:n,routeParams:r})),t}),o.length){var r=reduce(o,function(e,t){return(isNull(e)||t.specificity>e.specificity)&&(e=t),e},null),a=r.routeDescription,u=r.routeString,c=clone(r.routeParams),l=c.pop()||"",d=map(u.match(namedParamRegex),function(e){return e.replace(":","")}),p=reduce(d,function(e,t,n){return e[t]=c[n+1],e},{});t=extend({},baseRoute,{id:a.id,controller:a.controller,title:a.title,url:e,segment:e.substr(0,e.length-l.length),indexedParams:c,namedParams:p})}return t||i},Router.prototype.getActionForRoute=function(e){var t=function(){delete this.__currentRouteDescription,this.$outlet.reset()}.bind(this);return isRoute(e)&&(t=function(){isUndefined(e.title)||(document.title=isFunction(e.title)?e.title.call(this,e.namedParams,this.urlParts()):e.title),(isUndefined(this.__currentRouteDescription)||this.__currentRouteDescription.id!==e.id)&&(e.controller.call(this,e.namedParams),this.__currentRouteDescription=e)}.bind(this)),t},Router.prototype.getRouteDescriptions=function(){return this.routeDescriptions};var defaultGetViewModelOptions={includeOutlets:!1};fw.viewModels={};var getViewModels=fw.viewModels.getAll=function(e,t){return t=t||{},(isString(e)||isArray(e))&&(t.namespaceName=e),reduce($globalNamespace.request("__model_reference",extend({},defaultGetViewModelOptions,t),!0),function(e,t){if(!isUndefined(t)){var n=isNamespace(t.$namespace)?t.$namespace.getName():null;isNull(n)||(isUndefined(e[n])?e[n]=t:(isArray(e[n])||(e[n]=[e[n]]),e[n].push(t)))}return e},{})},defaultViewModelConfigParams={namespace:void 0,name:void 0,autoRegister:!1,autoIncrement:!1,mixins:void 0,params:void 0,initialize:noop,afterInit:noop,afterBinding:noop,onDispose:noop},makeViewModel=fw.viewModel=function(e){e=e||{};var t=noop,n=noop,i=e.parent;isUndefined(e)||(t=e.viewModel||e.initialize||noop,n=e.afterInit||noop),n={_postInit:n},e=extend({},defaultViewModelConfigParams,e);var s={_preInit:function(){isObject(e.router)&&(this.$router=new Router(e.router,this))},mixin:{__isViewModel:!0,$params:result(e,"params"),__getConfigParams:function(){return e},dispose:function(){this._isDisposed||(this._isDisposed=!0,e.onDispose!==noop&&e.onDispose.call(this),each(this,propertyDisposal))}},_postInit:function(){this.__assertPresence!==!1&&this.$globalNamespace.request.handler("__model_reference",function(e){if(!this.__isOutlet||isObject(e)&&e.includeOutlets){if(!isString(e.namespaceName)&&!isArray(e.namespaceName))return this;if(isArray(e.namespaceName)&&-1!==indexOf(e.namespaceName,this.getNamespaceName()))return this;if(isString(e.namespaceName)&&e.namespaceName===this.getNamespaceName())return this}}.bind(this))}};if(isViewModelCtor(t))u=t;else{var o=[t],r=reject(viewModelMixins,a),a=filter(viewModelMixins,a);a.length&&(o=o.concat(a)),o=o.concat(s),r.length&&(o=o.concat(r)),o=o.concat(n),isUndefined(e.mixins)||(o=o.concat(e.mixins)),each(o,function(e){isUndefined(e.runBeforeInit)||delete e.runBeforeInit});var u=riveter.compose.apply(void 0,o);u.__isViewModelCtor=!0,u.__configParams=e}if(isUndefined(i)||u.inherits(i),e.autoRegister){var c=e.namespace||e.name;if(isRegisteredViewModel(c)){if(getRegisteredViewModel(c)!==u)throw"namespace ["+c+"] already registered using a different viewModel, autoRegister failed."}else registerViewModel(c,u)}return u},originalApplyBindings=fw.applyBindings,applyBindings=fw.applyBindings=function(e,t){originalApplyBindings(e,t),applyContextAndLifeCycle(e,t)},originalComponentInit=fw.bindingHandlers.component.init;fw.bindingHandlers.component.init=function(e,t,n,i,s){var o=t;if(isString(e.tagName)){var r=e.tagName.toLowerCase();if("viewmodel"===r){var a=t(),u=(isUndefined(a.params)?void 0:fw.unwrap(a.params.name))||e.getAttribute("module")||e.getAttribute("data-module"),c=bindComponentViewModel.bind(null,e,a.params);if(!isUndefined(u)){var l=null;if(l=isRegisteredViewModel(u)?getRegisteredViewModel(u):isFunction(require)&&isFunction(require.defined)&&require.defined(u)?u:getViewModelResourceLocation(u),isString(l)){if(!isFunction(require))throw"Uses require, but no AMD loader is present";isPath(l)&&(l+=getViewModelFileName(u)),require([l],c)}else isFunction(l)?c(l):isObject(l)&&(isObject(l.instance)?c(l.instance):isFunction(l.createViewModel)&&c(l.createViewModel(a.params,{element:e})))}return{controlsDescendantBindings:!0}}if("outlet"===r){var d=e.getAttribute("name")||e.getAttribute("data-name");d&&(o=function(){var e=t();return!isUndefined(e.params)&&isUndefined(e.params.name)&&(e.params.name=d),e})}}return originalComponentInit(e,o,n,i,s)};var originalComponentRegisterFunc=fw.components.register,registerComponent=fw.components.register=function(e,t){var n=t.initialize||t.viewModel;if(!isString(e))throw"Components must be provided a componentName.";isFunction(n)&&!isViewModelCtor(n)&&(t.namespace=e,n=makeViewModel(t)),originalComponentRegisterFunc(e,{viewModel:n||fw.viewModel(),template:t.template})};fw.components.getNormalTagList=function(){return nonComponentTags.splice(0)},fw.components.getComponentNameForNode=function(e){var t=isString(e.tagName)&&e.tagName.toLowerCase();return fw.components.isRegistered(t)||tagIsComponent(t)?t:null};var makeComponent=fw.component=function(e){var t=e.viewModel;return isFunction(t)&&!isViewModelCtor(t)&&(e.viewModel=makeViewModel(omit(e,"template"))),e},componentTemplateOnlyRegister=[],registerComponentAsTemplateOnly=fw.components.isTemplateOnly=function(e,t){return t=isUndefined(t)?!0:t,isArray(e)&&each(e,function(e){registerComponentAsTemplateOnly(e,t)}),componentTemplateOnlyRegister[e]=t,isArray(e)?void 0:componentTemplateOnlyRegister[e]||"normal"},nonComponentTags=["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","footer","form","frameset","g","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","nav","nobr","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","polygon","path","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","svg","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr","xmp","rect","image","lineargradient","stop","line"],tagIsComponent=fw.components.tagIsComponent=function(e,t){return isUndefined(t)?-1===indexOf(nonComponentTags,e):(isArray(e)&&each(e,function(e){tagIsComponent(e,t)}),t!==!0?contains(nonComponentTags,e)===!1&&nonComponentTags.push(e):nonComponentTags=filter(nonComponentTags,function(t){return t!==e}),void 0)},nativeComponents=["outlet"];fw.virtualElements.allowedBindings.$life=!0,fw.bindingHandlers.$life={init:function(e,t,n,i){fw.utils.domNodeDisposal.addDisposeCallback(e,function(){isViewModel(i)&&i.dispose()})},update:function(e,t,n,i,s){var o=s.$parent;isObject(o)&&o.__isOutlet&&o.$route().__getOnCompleteCallback()(e.parentElement||e.parentNode),componentTriggerAfterBinding(e.parentElement||e.parentNode,s.$data)}};var componentWrapperTemplate="<!-- ko $life -->COMPONENT_MARKUP<!-- /ko -->";fw.components.loaders.unshift(fw.components.componentWrapper={loadTemplate:function(e,t,n){if(isNativeComponent(e))n(null);else{if(!isString(t))throw"Unhandled config type "+typeof t+".";t=componentWrapperTemplate.replace(/COMPONENT_MARKUP/,t),fw.components.defaultLoader.loadTemplate(e,t,n)}},loadViewModel:function(e,t,n){var i=t.viewModel||t;isNativeComponent(e)?n(null):n(function(e,t){var n=t.element,s=8===n.nodeType?n.parentElement||n.parentNode:n,o=fw.contextFor(s),r=i;return isFunction(i)?(isViewModelCtor(i)||(i=makeViewModel({initialize:i})),r=i.compose({_preInit:function(){this.$context=o,this.$element=s}}),new r(e)):r})}}),fw.components.loaders.push(fw.components.requireLoader={getConfig:function(e,t){var n,i,s,o=getComponentFileName(e,"combined"),r=getComponentFileName(e,"viewModel"),a=getComponentFileName(e,"template"),u=getComponentResourceLocation(e),c=null;if(isFunction(require))if(require.defined(e))c={require:e};else if(isString(u.combined))s=u.combined,isPath(s)&&(s+=o),c={require:s};else{n=u.viewModels,i="text!"+u.templates,isPath(n)&&(n+=r),isPath(i)&&(i+=a);var l={require:n};componentTemplateOnlyRegister[e]&&(l={instance:{}}),c={viewModel:l,template:{require:i}}}t(c)}});var noParentViewModelError={getNamespaceName:function(){return"NO-VIEWMODEL-IN-CONTEXT"}};fw.virtualElements.allowedBindings.$bind=!0,fw.bindingHandlers.$bind={init:function(e,t,n,i,s){var o=isObject(s)?s.$parent||noParentViewModelError:noParentViewModelError,r=nearestParentRouter(s),a=i.outletName;if(!isRouter(r))throw"Outlet ["+a+"] defined inside of viewModel ["+o.getNamespaceName()+"] but no router was defined.";i.$route=r.$outlet(a)}},registerComponent("outlet",{autoIncrement:!0,viewModel:function(e){this.outletName=fw.unwrap(e.name),this.__isOutlet=!0},template:"<!-- ko $bind, component: $route --><!-- /ko -->"}),registerComponent("_noComponentSelected",{viewModel:function(){this.__assertPresence=!1},template:'<div class="no-component-selected"></div>'}),registerComponent("error",{viewModel:function(e){this.message=fw.observable(e.message),this.errors=e.errors,this.__assertPresence=!1},template:'    <div class="component error" data-bind="foreach: errors">      <div class="error">        <span class="number" data-bind="text: $index() + 1"></span>        <span class="message" data-bind="text: $data"></span>      </div>    </div>'});var defaultComponentFileExtensions={combined:".js",viewModel:".js",template:".html"},componentFileExtensions=fw.components.fileExtensions=fw.observable(clone(defaultComponentFileExtensions)),componentIsRegistered=fw.components.isRegistered,getComponentFileName=fw.components.getFileName=function(e,t){var n=componentFileExtensions(),i=e;if(componentIsRegistered(e))return null;switch(isFunction(n)?i+=n(e)[t]:isObject(n)&&(i+=isFunction(n[t])?n[t](e):n[t]||""),t){case"viewModel":t="viewModels";break;case"template":t="templates"}if(!isUndefined(componentResourceLocations[e])){var s=componentResourceLocations[e];if(!isUndefined(s[t])&&!isPath(s[t])){if(!isString(s[t]))return null;i=last(s[t].split("/"))}}return i},defaultComponentLocation={combined:null,viewModels:"/viewModel/",templates:"/component/"},componentResourceLocations=fw.components.resourceLocations={},componentDefaultLocation=fw.components.defaultLocation=function(e,t){var n=isUndefined(t)||t===!0?defaultComponentLocation:clone(defaultComponentLocation);return isObject(e)?extend(n,reduce(e,function(e,t,n){return"viewModel"===n?(e.viewModels=t,delete e.viewModel):"template"===n?(e.templates=t,delete e.template):e[n]=t,e},{})):isString(e)&&(n={combined:rootURL,viewModels:null,templates:null}),n},registerLocationOfComponent=fw.components.registerLocation=function(e,t){isArray(e)&&each(e,function(e){registerLocationOfComponent(e,t)}),componentResourceLocations[e]=componentDefaultLocation(t,!1)},getComponentResourceLocation=fw.components.getResourceLocation=function(e){return isUndefined(e)?componentResourceLocations:componentResourceLocations[e]||defaultComponentLocation},defaultViewModelFileExtensions=".js",viewModelFileExtensions=fw.viewModels.fileExtensions=fw.observable(defaultViewModelFileExtensions),getViewModelFileName=fw.viewModels.getFileName=function(e){var t=viewModelFileExtensions(),n=e;if(isFunction(t)?n+=t(e):isString(t)&&(n+=t),!isUndefined(viewModelResourceLocations[e])){var i=viewModelResourceLocations[e];isString(i)&&!isPath(i)&&(n=last(i.split("/")))}return n},defaultViewModelLocation="/viewModel/",viewModelResourceLocations=fw.viewModels.resourceLocations={},viewModelDefaultLocation=fw.viewModels.defaultLocation=function(e,t){var n=defaultViewModelLocation;return isString(e)&&(n=e),t&&(defaultViewModelLocation=n),n},registeredViewModels={},registerViewModel=fw.viewModels.register=function(e,t){registeredViewModels[e]=t},isRegisteredViewModel=fw.viewModels.isRegistered=function(e){return!isUndefined(registeredViewModels[e])},getRegisteredViewModel=fw.viewModels.getRegistered=function(e){return registeredViewModels[e]},registerLocationOfViewModel=fw.viewModels.registerLocation=function(e,t){isArray(e)&&each(e,function(e){registerLocationOfViewModel(e,t)}),viewModelResourceLocations[e]=viewModelDefaultLocation(t,!1)},getViewModelResourceLocation=fw.viewModels.getResourceLocation=function(e){return isUndefined(e)?viewModelResourceLocations:viewModelResourceLocations[e]||getComponentResourceLocation(e).viewModels||defaultViewModelLocation};fw.extenders.debounce=function(e,t){isNumber(t)&&(t={timeout:t,when:function(){return!0}}),e.throttleEvaluation=t.timeout;var n=null,i=fw.computed({read:e,write:function(i){t.when(i)?(clearTimeout(n),n=setTimeout(function(){e(i)},t.timeout)):(clearTimeout(n),e(i))}});i.force=function(t){clearTimeout(n),e(t)};var s=i.dispose;return isFunction(e.dispose)&&(i.dispose=function(){e.dispose(),s.call(i)
}),i},fw.extenders.autoDisable=function(e,t){return e.extend({delayTrigger:{delay:t||0,trigger:function(e){e(!1)}}})},fw.extenders.autoEnable=function(e,t){return e.extend({delayTrigger:{delay:t||0,trigger:function(e){e(!0)}}})},fw.extenders.delayTrigger=function(e,t){var n,i=300,s=noop;isObject(t)?(i=!isNaN(t.delay)&&parseInt(t.delay,10)||i,s=t.trigger||s):i=!isNaN(t)&&parseInt(t,10)||i;var o=function(){clearTimeout(n),n=void 0},r=fw.computed({read:e,write:function(i){e(i),isUndefined(n)||o(),n=setTimeout(function(){s(e,t)}.bind(e),r.triggerDelay)}});r.clearTrigger=o,r.triggerDelay=i;var a=r.dispose;return isFunction(e.dispose)&&(r.dispose=function(){e.dispose(),a.call(r)}),r},fw.extenders.delayWrite=function(e,t){var n,i=300;isObject(t)?(i=!isNaN(t.delay)&&parseInt(t.delay,10)||i,n=t.filter||function(){return!0}):i=!isNaN(t)&&parseInt(t,10)||i;var s=fw.computed({read:e,write:function(t){n(t)?(e._delayWriteTimer&&clearTimeout(this._delayWriteTimer),e._delayWriteTimer=setTimeout(function(){e(t)},i)):e(t)}}),o=s.dispose;return isFunction(e.dispose)&&(s.dispose=function(){e.dispose(),o.call(s)}),s};