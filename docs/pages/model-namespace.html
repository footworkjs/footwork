<ul class="sections">
    
    
    <li id="section-1">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-1">&#182;</a>
          </div>
          <h2 id="namespace-and-model-creation-management-">Namespace and model creation / management.</h2>

        </div>
        
        <div class="content"><div class='highlight'><pre>
ko.__nsStack = [];

<span class="hljs-comment">/**
 * Creates and returns a new namespace channel
 *
 * @param {namespaceName} string - The name of the namespace
 * @return {channel}
 */</span>
ko.namespace = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(namespaceName)</span> {</span>
  <span class="hljs-keyword">return</span> postal.channel(namespaceName);
};
<span class="hljs-comment">/** Return the current namespace name. */</span>
ko.currentNamespaceName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> ko.__nsStack[<span class="hljs-number">0</span>];
};
ko.currentNamespace = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> ko.namespace(ko.currentNamespaceName());
};
ko.enterNamespaceName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(namespaceName)</span> {</span>
  ko.__nsStack.unshift( namespaceName );
};</pre></div></div>
        
    </li>
    
    
    <li id="section-2">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-2">&#182;</a>
          </div>
          <p>Called at the after a model constructor function is run. exitNamespace()
will shift the current namespace off of the stack, exiting to the
next namespace in the stack</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>ko.exitNamespace = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  ko.__nsStack.shift();
};</pre></div></div>
        
    </li>
    
    
    <li id="section-3">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-3">&#182;</a>
          </div>
          <p>Returns the model count for each currently defined namespace</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>ko.modelCount = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> counts = _.reduce(namespaceNameCounter, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(modelCounts, modelCount, modelName)</span> {</span>
    modelCounts[modelName] = modelCount + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> modelCounts;
  }, {});
  counts.__total = _.reduce(_.values(counts), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(summation, num)</span> {</span>
    <span class="hljs-keyword">return</span> summation + num;
  }, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> counts;
};

ko.getModels = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(namespaceName)</span> {</span>
  <span class="hljs-keyword">if</span>(namespaceName === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">return</span> models;
  }
  <span class="hljs-keyword">return</span> models[namespaceName];
};

ko.debugModels = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(state)</span> {</span>
  debugModels = state;
};

ko.refreshModels = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  _.invoke(ko.getModels(), <span class="hljs-string">'refreshReceived'</span>);
};

<span class="hljs-keyword">var</span> models = {},
    modelNum = <span class="hljs-number">0</span>,
    debugModels = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">var</span> namespaceNameCounter = {};

<span class="hljs-keyword">var</span> indexedNamespaceName = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, autoIncrement)</span> {</span>
  <span class="hljs-keyword">if</span>(namespaceNameCounter[name] === <span class="hljs-literal">undefined</span>) {
    namespaceNameCounter[name] = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> {
    namespaceNameCounter[name]++;
  }
  <span class="hljs-keyword">return</span> name + ((autoIncrement === <span class="hljs-literal">true</span> &amp;&amp; namespaceNameCounter[name] &gt; <span class="hljs-number">0</span>) ? namespaceNameCounter[name] : <span class="hljs-string">''</span>);
};

ko.model = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(modelOptions)</span> {</span>
  modelOptions = _.extend({
    namespace: <span class="hljs-literal">undefined</span>,
    autoIncrement: <span class="hljs-literal">false</span>,
    mixins: <span class="hljs-literal">undefined</span>,
    params: <span class="hljs-literal">undefined</span>,
    afterBinding: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>},
    factory: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>}
  }, modelOptions);

  <span class="hljs-keyword">var</span> viewModel = {
    _preInit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( options )</span> {</span>
      modelOptions.namespace = indexedNamespaceName(modelOptions.namespace, modelOptions.autoIncrement);

      <span class="hljs-keyword">this</span>._modelOptions = modelOptions;
      ko.enterNamespaceName(modelOptions.namespace);

      <span class="hljs-keyword">this</span>._options = _.extend({
        namespace: modelOptions.namespace || (<span class="hljs-string">'namespace'</span> + modelNum)
      }, options);
      modelNum++;

      <span class="hljs-keyword">this</span>.namespace = ko.namespace( <span class="hljs-keyword">this</span>.namespace = <span class="hljs-keyword">this</span>._options.namespace );
      <span class="hljs-keyword">if</span>(ko.currentNamespace().channel !== <span class="hljs-string">'/'</span>) {
        <span class="hljs-keyword">this</span>.namespace = ko.currentNamespace();
      }
      <span class="hljs-keyword">this</span>._globalChannel = ko.namespace();
    },
    mixin: {
      namespaceName: modelOptions.namespace,
      broadcastAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>._broadcast === <span class="hljs-string">'object'</span>) {
          _.each( <span class="hljs-keyword">this</span>._broadcast, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( observable, observableName )</span> {</span>
            model.namespace.publish( observableName, observable() );
          });
        }

        _.each( <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(property, propName)</span> {</span>
          <span class="hljs-keyword">if</span>( _.isObject(property) === <span class="hljs-literal">true</span> &amp;&amp; property.__isBroadcast === <span class="hljs-literal">true</span> ) {
            model.namespace.publish( propName, property() );
          }
        });
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      },
      refreshReceived: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>._receive === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-keyword">this</span>._receive.refresh !== <span class="hljs-literal">undefined</span> ) {
          _.invoke( <span class="hljs-keyword">this</span>._receive, <span class="hljs-string">'refresh'</span> );
          <span class="hljs-keyword">if</span>( <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>._receive.config === <span class="hljs-string">'object'</span> ) {
            _.invoke( <span class="hljs-keyword">this</span>._receive.config, <span class="hljs-string">'refresh'</span> );
          }
        }

        _.each( <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(property, propName)</span> {</span>
          <span class="hljs-keyword">if</span>( _.isObject(property) === <span class="hljs-literal">true</span> &amp;&amp; property.__isReceived === <span class="hljs-literal">true</span> ) {
            property.refresh();
          }
        });
        <span class="hljs-keyword">if</span>( _.isObject(<span class="hljs-keyword">this</span>.config) === <span class="hljs-literal">true</span> ) {
          _.invoke( <span class="hljs-keyword">this</span>.config, <span class="hljs-string">'refresh'</span> );
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      },
      startup: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>.refreshReceived().broadcastAll();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
      }
    },
    _postInit: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( options )</span> {</span>
      <span class="hljs-keyword">if</span>(debugModels === <span class="hljs-literal">true</span>) {
        models[ ko.currentNamespace().channel ] = <span class="hljs-keyword">this</span>;
      }

      ko.exitNamespace();
      <span class="hljs-keyword">this</span>.startup();
      <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>._modelOptions.afterCreating === <span class="hljs-string">'function'</span> &amp;&amp; <span class="hljs-keyword">this</span>._modelOptions.afterCreating.call(<span class="hljs-keyword">this</span>);
    }
  };

  <span class="hljs-keyword">var</span> composure = [ modelOptions.factory, viewModel ];
  <span class="hljs-keyword">if</span>(modelOptions.mixins !== <span class="hljs-literal">undefined</span>) {
    composure = composure.concat(modelOptions.mixins);
  }
  <span class="hljs-keyword">return</span> riveter.compose.apply( <span class="hljs-literal">undefined</span>, composure );
};</pre></div></div>
        
    </li>
    
</ul>