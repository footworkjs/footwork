(function(e,t){typeof module=="object"&&module.exports?module.exports=t(require("lodash"),require("conduitjs"),this):typeof define=="function"&&define.amd?define(["lodash","conduitjs"],function(n,r){return t(n,r,e)}):e.postal=t(e._,e.Conduit,e)})(this,function(e,t,n,r){function v(){while(d.length)i.unsubscribe(d.shift())}function m(e,t){return{channel:i.configuration.SYSTEM_CHANNEL,topic:"subscription."+e,data:{event:"subscription."+e,channel:t.channel,topic:t.topic}}}function g(t){return typeof t=="function"?t:t?function(n){var r=0,s=0;return e.each(t,function(e,o){r+=1;if(o==="topic"&&i.configuration.resolver.compare(n.topic,t.topic)||o==="context"&&t.context===(n.callback.context&&n.callback.context()||n.context)||n[o]===t[o])s+=1}),r===s}:function(){return!0}}function y(e){var t=new u(e.channel||this.configuration.DEFAULT_CHANNEL,e.topic,e.callback),n=this.subscriptions[t.channel],r;return n||(n=this.subscriptions[t.channel]={}),r=this.subscriptions[t.channel][t.topic],r||(r=this.subscriptions[t.channel][t.topic]=[]),r.push(t),t}function b(t){++p,t.channel=t.channel||this.configuration.DEFAULT_CHANNEL,t.timeStamp=new Date,e.each(this.wireTaps,function(e){e(t.data,t)}),this.subscriptions[t.channel]&&e.each(this.subscriptions[t.channel],function(e){var n=0,r=e.length,i;while(n<r)(i=e[n++])&&h(i,t)}),--p===0&&v()}function w(){var e=0,t=Array.prototype.slice.call(arguments,0),n;while(n=t.shift()){if(p){d.push(n);return}if(this.subscriptions[n.channel]&&this.subscriptions[n.channel][n.topic]){var r=this.subscriptions[n.channel][n.topic].length;e=0;while(e<r){if(this.subscriptions[n.channel][n.topic][e]===n){this.subscriptions[n.channel][n.topic].splice(e,1);break}e+=1}}i.publish(m("removed",n))}}var i,s=n.postal,o=function(e){this.channel=e||i.configuration.DEFAULT_CHANNEL,this.initialize()};o.prototype.initialize=function(){var e=this.publish;this.publish=new t.Async({target:e,context:this})},o.prototype.subscribe=function(){return i.subscribe({channel:this.channel,topic:arguments.length===1?arguments[0].topic:arguments[0],callback:arguments.length===1?arguments[0].callback:arguments[1]})},o.prototype.publish=function(){var e=arguments.length===1?Object.prototype.toString.call(arguments[0])==="[object String]"?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};e.channel=this.channel,i.publish(e)};var u=function(e,t,n){if(arguments.length!==3)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(t.length===0)throw new Error("Topics cannot be empty");this.channel=e,this.topic=t,this.subscribe(n)},a=function(){var t;return function(n){var r=!1;return e.isString(n)?(r=n===t,t=n):(r=e.isEqual(n,t),t=e.clone(n)),!r}},f=function(){var t=[];return function(n){var r=!e.any(t,function(t){return e.isObject(n)||e.isArray(n)?e.isEqual(n,t):n===t});return r&&t.push(n),r}},l={withDelay:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";return{name:"withDelay",fn:function(e,n,r){setTimeout(function(){e(n,r)},t)}}},defer:function(){return this.withDelay(0)},stopAfter:function(t,n){if(e.isNaN(t)||t<=0)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var r=e.after(t,n);return{name:"stopAfter",fn:function(e,t,n){r(),e(t,n)}}},withThrottle:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";return{name:"withThrottle",fn:e.throttle(function(e,t,n){e(t,n)},t)}},withDebounce:function(t,n){if(e.isNaN(t))throw"Milliseconds must be a number";return{name:"debounce",fn:e.debounce(function(e,t,n){e(t,n)},t,!!n)}},withConstraint:function(t){if(!e.isFunction(t))throw"Predicate constraint must be a function";return{name:"withConstraint",fn:function(e,n,r){t.call(this,n,r)&&e.call(this,n,r)}}},distinct:function(e){e=e||{};var t=function(e){return e[0]},n=e.all?new f(t):new a(t);return{name:"distinct",fn:function(e,t,r){n(t)&&e(t,r)}}}};u.prototype={after:function(){return this.callback.after.apply(this,arguments),this},before:function(){return this.callback.before.apply(this,arguments),this},"catch":function(e){var t=this.callback.target(),n=function(){try{t.apply(this,arguments)}catch(n){e(n,arguments[0])}};return this.callback.target(n),this},defer:function(){return this.callback.before(l.defer()),this},disposeAfter:function(e){var t=this;return t.callback.before(l.stopAfter(e,function(){t.unsubscribe.call(t)})),t},distinctUntilChanged:function(){return this.callback.before(l.distinct()),this},distinct:function(){return this.callback.before(l.distinct({all:!0})),this},logError:function(){if(console){var e;console.warn?e=console.warn:e=console.log,this.catch(e)}return this},once:function(){return this.disposeAfter(1),this},subscribe:function(e){return this.callback=new t.Async({target:e,context:this}),this},unsubscribe:function(){this.inactive||(this.inactive=!0,i.unsubscribe(this))},withConstraint:function(e){return this.callback.before(l.withConstraint(e)),this},withConstraints:function(e){while(e.length)this.callback.before(l.withConstraint(e.shift()));return this},withDebounce:function(e,t){return this.callback.before(l.withDebounce(e,t)),this},withDelay:function(e){return this.callback.before(l.withDelay(e)),this},withThrottle:function(e){return this.callback.before(l.withThrottle(e)),this},withContext:function(e){return this.callback.context(e),this}};var c={cache:{},regex:{},compare:function(t,n){var r,i,s,o=this.cache[n]&&this.cache[n][t];return typeof o!="undefined"?o:((i=this.regex[t])||(r="^"+e.map(t.split("."),function(e){var t="";return!s||(t=s!=="#"?"\\.\\b":"\\b"),e==="#"?t+="[\\s\\S]*":e==="*"?t+="[^.]+":t+=e,s=e,t}).join("")+"$",i=this.regex[t]=new RegExp(r)),this.cache[n]=this.cache[n]||{},this.cache[n][t]=o=i.test(n),o)},reset:function(){this.cache={},this.regex={}}},h=function(e,t){!e.inactive&&i.configuration.resolver.compare(e.topic,t.topic)&&e.callback(t.data,t)},p=0,d=[];i={configuration:{resolver:c,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal"},subscriptions:{},wireTaps:[],ChannelDefinition:o,SubscriptionDefinition:u,channel:function(e){return new o(e)},addWireTap:function(e){var t=this;return t.wireTaps.push(e),function(){var n=t.wireTaps.indexOf(e);n!==-1&&t.wireTaps.splice(n,1)}},noConflict:function(){if(typeof window=="undefined"||typeof window!="undefined"&&typeof define=="function"&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return n.postal=s,this},getSubscribersFor:function(t){var n=[];return e.each(this.subscriptions,function(r){e.each(r,function(r){n=n.concat(e.filter(r,g(t)))})}),n},reset:function(){this.unsubscribeFor(),this.configuration.resolver.reset(),this.subscriptions={}},unsubscribeFor:function(e){var t=[];this.subscriptions&&(t=this.getSubscribersFor(e),this.unsubscribe.apply(this,t))}},i.subscribe=new t.Sync({target:y,context:i}),i.publish=t.Async({target:b,context:i}),i.unsubscribe=new t.Sync({target:w,context:i}),i.subscribe.after(function(e){i.publish(m("created",e))}),i.subscriptions[i.configuration.SYSTEM_CHANNEL]={},i.linkChannels=function(t,n){var r=[],i=this;return t=e.isArray(t)?t:[t],n=e.isArray(n)?n:[n],e.each(t,function(t){var s=t.topic||"#";e.each(n,function(n){var o=n.channel||i.configuration.DEFAULT_CHANNEL;r.push(i.subscribe({channel:t.channel||i.configuration.DEFAULT_CHANNEL,topic:s,callback:function(t,r){var s=e.clone(r);s.topic=e.isFunction(n.topic)?n.topic(r.topic):n.topic||r.topic,s.channel=o,s.data=t,i.publish(s)}}))})}),r};if(n&&Object.prototype.hasOwnProperty.call(n,"__postalReady__")&&e.isArray(n.__postalReady__))while(n.__postalReady__.length)n.__postalReady__.shift().onReady(i);return i});