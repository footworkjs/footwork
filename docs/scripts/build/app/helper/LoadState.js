define(["jquery","lodash","knockout-footwork","LoadProfile"],function(e,t,n,r){var i=!0,s=!1;return function(u){this.watchState=n.observable(),this.loading=n.observable(),this.message=n.observable("[*]"),this.oldState=n.observable(),this.failReason=n.observable(""),this.percentComplete=n.observable(0).extend({read:function(e){return e()+"%"}}),this.stepTransitionDuration=n.observable(0).extend({read:function(e){return e()+"ms"}}),this.stepTransition=n.computed(function(){var e=this.loading();return e===i?"opacity 0ms 20ms linear, width "+this.stepTransitionDuration()+" 0ms linear":"opacity 350ms 500ms linear, width "+this.stepTransitionDuration()+" 0ms linear"},this),u!==undefined&&u.ignoreStatus!==undefined&&u.ignoreStatus instanceof Array==0&&(u.ignoreStatus=[u.ignoreStatus]),this.options=e.extend(!0,{speed:"normal-load",watchState:this.watchState,exportState:!1,ignoreStatus:[],showFailMessage:!0,messageStates:{ready:"[ready]",busy:"Loading...",success:"Done.",fail:"Error."}},u||{}),this.watchState=this.options.watchState;var a=100,f=(new r).bind("start",function(){this.stepTransitionDuration(0),setTimeout(function(){this.percentComplete(0)}.bind(this),0)}.bind(this)).bind("step",function(e){e.point&&(this.stepTransitionDuration(e.duration>a?e.duration:a),this.percentComplete(e.point))}.bind(this)).bind("end",function(e){e&&this.percentComplete(100)}.bind(this));this.loading.subscribe(function(e){typeof this.options.exportState=="function"&&this.options.exportState(e),e===i?f.start():f.end()},this),this.loading.toggle=function(){this.loading(!this.loading())}.bind(this),this.loading(this.options.isLoading),this.state=n.computed(function(){var e=[];return this.oldState()==="fail"&&e.push("fail"),this.loading()?e.push("loading"):e.push("loaded"),e.join(" ")},this);var l=function(e){var n=e;typeof e=="object"&&e.join&&(n=e.join(", "));var r="["+n+" - unknown state]";return t.each(this.options.messageStates,function(n,i){if(typeof e=="string"&&e===i||typeof e=="object"&&t.indexOf(e,i)!==-1)typeof n=="function"?r=n(this.failReason()):this.options.showFailMessage===!0&&this.failReason().length?r=this.failReason():r=n}.bind(this)),r}.bind(this),c=t.invert({busy:!0,success:!1});return this.setState=function(e){var t=e;e===undefined&&(e=this.oldState()),this.oldState(e),typeof e=="boolean"&&(e=c[e]);switch(e){case"busy":case"then":this.loading(i);break;case"ready":case"success":case"done":this.loading(s);break;case"fail":break;default:throw"Unknown load bar state ["+t+"]."}this.message(l(e))},this.options.watchState.subscribe(this.setState,this),this.watch=function(e,t,n){var r=this,i=(new Date).getTime();this.loadTimer&&clearTimeout(this.loadTimer),n=n||function(){},t=t||0,e.state()==="pending"&&(this.loading(!1),this.setState("busy"));var s=function(e){var s=(new Date).getTime()-i;s<t?this.loadTimer=setTimeout(function(){r.setState(e),n()}.bind(this),t-s):r.setState(e)}.bind(this);return e.done(function(){this.failReason(""),s("success")}.bind(this)).fail(function(e){this.failReason(e.statusText==="error"?"Unknown error":e.status),this.options.ignoreStatus.indexOf(e.status)!==-1?s("success"):s("fail")}.bind(this))},this.setState("ready"),this}});