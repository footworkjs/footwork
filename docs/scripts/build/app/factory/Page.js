define(["jquery","lodash","knockout-footwork","history"],function(e,t,n){return n.model({namespace:"Page",afterCreating:function(){var e=window._pageMeta,t=n.namespace("PageSection");this.url(document.URL),e&&(this.loadMeta(e),e.sections!==undefined&&e.sections.length&&location.hash.length&&t.publish("scrollToSection",location.hash.slice(location.hash.indexOf("#")+1)))},factory:function(){var t=n.namespace("PageSections"),r=n.namespace("PaneElements"),i=e(".js-main");this.defaultTitle=n.observable("staticty.pe"),this.transitionsEnabled=n.observable(!1).receiveFrom("ViewPort","transitionsEnabled"),this.scrollPosition=n.observable().receiveFrom("ViewPort","scrollPosition"),this.maxScrollResetPosition=n.observable().receiveFrom("ViewPort","maxScrollResetPosition"),this.viewPortLayoutMode=n.observable().receiveFrom("ViewPort","layoutMode"),this.overlapPane=n.observable().receiveFrom("Body","overlapPane"),this.paneCollapsed=n.observable().receiveFrom("Pane","collapsed"),this.url=n.observable().extend({write:function(e,t){var n=t.indexOf("#");n!==-1?(this.baseURL(t.substr(0,n)),this.hashURL(t.substr(n+1))):(this.baseURL(t),this.hashURL("")),e(t)}.bind(this)}).broadcastAs("url"),this.baseURL=n.observable().broadcastAs("baseURL"),this.hashURL=n.observable().broadcastAs("hashURL",!0),this.title=n.observable(this.defaultTitle()).broadcastAs("title"),this.shortTitle=n.observable(this.defaultTitle()).broadcastAs("shortTitle"),this.loading=n.observable().broadcastAs("loading"),History.Adapter.bind(window,"statechange",this.loadState=function(){var t=History.getState().url;this.url(t),window._pageMeta=undefined,this.loadingPagePromise!==undefined&&this.loadingPagePromise.abort(),this.loadingPagePromise=e.ajax({url:t+"?content-only"}).done(function(e){var t=this.maxScrollResetPosition();this.loading(!0),i.html(e),this.viewPortLayoutMode()!=="mobile"&&r.publish("hideAll"),this.scrollPosition()>t&&window.scrollTo(0,t),this.loadMeta(window._pageMeta),setTimeout(function(){this.loading(!1)}.bind(this),20)}.bind(this)).always(function(){this.loading(!1)}.bind(this)).fail(function(e){i.html(e.responseText)}),this.namespace.publish("loadingPage",this.loadingPagePromise)}.bind(this)),this.loadMeta=function(e){e!==undefined&&(t.publish("load",e),this.title(e.title+" - "+this.defaultTitle()),this.shortTitle(e.title||this.defaultTitle()))}.bind(this),this.loadURL=function(e,n){return History.enabled?(History.getState().url.split("").reverse().join("").substring(0,e.length)!==e.split("").reverse().join("")?t.publish("clear"):(this.loading(!0),setTimeout(function(){this.loading(!1)}.bind(this),20)),this.overlapPane()===!0&&this.paneCollapsed()===!1&&this.paneCollapsed(!0),History.pushState(null,n&&n+" - "+this.defaultTitle()||this.defaultTitle(),e),!0):(window.location=e,!1)}.bind(this),this.namespace.subscribe("initMeta",function(e){this.loadMeta(e)}).withContext(this),this.namespace.subscribe("loadURL",function(e){this.loadURL(e.url,e.title)}).withContext(this)}})});