define(["require","jquery","lodash","knockout-footwork","LoadState"],function(e,t,n,r,i){var s,o=t("head"),u,a={},f=!1,l={bodyBG:"@body-bg-color",headerBG:"@header-bg",paneBG:"@pane-bg-color",controlsBG:"@controls-bg"},c=r.namespace("Configuration"),h=r.namespace("Themes"),p=r.observable().extend({throttle:{timeout:50,when:function(e){return e===!1}}}),d,v=function(){window.less!==undefined&&(clearTimeout(d),p(!0),d=setTimeout(function(){less.modifyVars(n.reduce(l,function(e,t,n){return e[t]=s.customizedTheme[n](),e},{})),t('style[id="less:css-style"]')[0].disabled=!1,u!==undefined&&(u[0].disabled=!0),p(!1),f!==!0&&h.publish("modified"),f=!1},100))},m=r.model({namespace:"Theme",factory:function(e){var t=/[^a-f0-9]/gi;e=e||{},this.themeParams={bodyBG:r.observable(),paneBG:r.observable(),headerBG:r.observable(),controlsBG:r.observable()},n.each(this.themeParams,function(t){e.updateLESS===!0&&t.subscribe(function(){v()},this)}.bind(this)),n.extend(this,this.themeParams),e.updateLESS===!0&&(this.sync=function(){n.each(this.themeParams,function(e,t){n.isEmpty(a)===!1&&a[t]!==undefined&&a[t].spectrum("set",e())})}),this.currentTheme=r.observable().receiveFrom("Themes","currentTheme"),this.importParams=function(e){var r=JSON.stringify(n.filter(e,function(e,t){return l[t]!==undefined}));r!==this._lastParamsLoad&&(p(!0),n.each(this.themeParams,function(n,r){e[r]!==undefined&&n("#"+e[r].replace(t,""))}.bind(this))),this._lastParamsLoad=r},this.importParams(e),this.active=r.computed(function(){return this.currentTheme()===this},this),this.choose=function(){this.currentTheme(this)},this.params=function(){return n.reduce(this.themeParams,function(e,n,r){return e[r]=n().replace(t,""),e},{})},this.filePartial=r.computed(function(){return n.reduce(this.params(),function(e,t){return e+(e.length?"-":"")+"#"+t},"")},this),n.invoke(this._receive,"refresh")}});return r.model({namespace:"Themes",afterBinding:function(){this.currentTheme(new m(window.theme))},factory:function(){s=this,this.config={visible:r.observable().receiveFrom("Configuration","visible")},this.scrollPosition=r.observable().receiveFrom("ViewPort","scrollPosition"),this.paneWidth=r.observable().receiveFrom("Pane","width"),this.visibleHeaderHeight=r.observable().receiveFrom("Header","visibleHeight"),this.currentTheme=r.observable().broadcastAs("currentTheme",!0),this.viewPortTheme=r.observable(),this.currentTab=r.observable("choose"),this.currentThemes=r.observableArray(),this.loading=r.observable(),this.loader=new i({exportState:this.loading,watchState:p,messageStates:{busy:function(){return this.currentTab()==="customize"?this._initializingCustomize===!0?"Loading runtime compiler...":"Compiling theme...":"Loading..."}.bind(this),success:function(){return this.currentTab()==="customize"?"Theme compiled...":"Loaded..."}.bind(this),fail:function(){return this._initializingCustomize===!0?"Could not load LESS runtime.":"Error."}}}),this.customizedTheme=new m({bodyBG:window.theme.bodyBG,controlsBG:window.theme.controlsBG,headerBG:window.theme.headerBG,paneBG:window.theme.paneBG,updateLESS:!0}),this.customizeAssetsLoaded=r.observable(!1),this.customizeModified=r.observable(!1),this.namespace.subscribe("modified",function(){this.customizeModified(!0)}).withContext(this),this.setVisible=function(e,n){this.loading()===!1&&this.currentTab(t(n.target).data("tab"))},this.useTheme=function(){var e;this.currentThemes.push(e=new m(this.customizedTheme.params())),this.currentTheme(e),this.customizeModified(!1)},this.chooseVisible=r.computed(function(){return this.currentTab()==="choose"},this),this.customizeVisible=r.computed(function(){var r=this.currentTab(),i=!1;return r==="customize"&&(t.fn.spectrum===undefined?(this._initializingCustomize=!0,this.loader.setState("busy"),e(["jquery.spectrum"],function(){var e,r=t(".js-theme-color-input");o.append(e=t('<link rel="stylesheet" type="text/css" href="css/lib/spectrum.css" />')),o.append(t('<link rel="stylesheet/less" type="text/css" href="css/style.less" />')),e.load(function(){n.each(r,function(e){var n,r=a[n=t(e).data("theme-property")]=t(e);r.spectrum({positioning:"fixed",showInitial:!0,showInput:!0,hide:function(){r.spectrum("position",!1)},change:function(e){this.customizedTheme[n](e.toHexString())}.bind(this)}).on("dragstop.spectrum",function(e,t){t=t.toHexString(),r.spectrum("set",t),this.customizedTheme[n](t)}.bind(this))}.bind(this)),this.customizedTheme.sync(),this.customizeAssetsLoaded(!0),this.visibleHeaderHeight.subscribe(function(){r.spectrum("hide")}),this.paneWidth.subscribe(function(){r.spectrum("hide")}),this._globalChannel.subscribe("enableControl",function(){r.spectrum("hide")}),c.subscribe("reset",function(){r.spectrum("hide")}),this.config.visible.subscribe(function(e){e===!1&&r.spectrum("hide")}),t.getScript("/scripts/lib/less.js").fail(function(){this.loader.setState("fail")}).done(function(){var e=this.currentTheme(),t;typeof e=="object"&&(t=e.params()),f=!0,this.customizedTheme.importParams(t||window.theme,!0),this._initializingCustomize=!1,this.loader.setState(),v()}.bind(this))}.bind(this))}.bind(this),function(){this.loader.setState("fail")})):(this.customizedTheme.importParams(this.currentTheme().params()),this.customizedTheme.sync()),i=!0),i},this);var l=t("#default-style").get(0),h=t("link[rel=icon]");return this.currentTheme.subscribe(function(e){if(this.config.visible()===!0){var n=encodeURIComponent(e.filePartial()),r="css/builds/build-"+n+".css",i="images/icon-builds/favicon-"+n+".png";u=t('<link rel="stylesheet" type="text/css" href="'+r+'" />'),p(!0),u.load(function(){this._chosenStyle!==undefined&&this._chosenStyle.remove(),this._chosenStyle=u,u.attr("id","chosen-style"),l.disabled=!0,c.publish("updateSession"),p(!1)}.bind(this)),o.append(u),h.attr("href",i)}},this),this.config.visible.subscribe(function(e){e===!0&&this.currentThemes().length===0&&this.loader.watch(t.getJSON("/theme/listAll")).done(function(e){var t=this.currentThemes();n.each(e,function(e){var n=new m(e);t.push(n),JSON.stringify(n.params())===JSON.stringify(window.theme)&&this.currentTheme(n)}.bind(this)),this.currentThemes.valueHasMutated()}.bind(this))},this),this.chooseColor=function(e,n){var r=t(n.target),i=r.data("theme-property");setTimeout(function(){a[i].spectrum("toggle").spectrum("position",{left:n.clientX,top:n.clientY+s.scrollPosition()})}.bind(this),0)},this}})});